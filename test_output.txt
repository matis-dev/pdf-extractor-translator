============================= test session starts ==============================
platform linux -- Python 3.12.7, pytest-7.4.4, pluggy-1.0.0 -- /home/matis/anaconda3/bin/python
cachedir: .pytest_cache
rootdir: /home/matis/Desktop/projects/pdf
configfile: pytest.ini
plugins: anyio-4.12.0, Faker-38.2.0, langsmith-0.5.0, base-url-2.1.0, flask-1.3.0, mock-3.15.1, playwright-0.7.2
collecting ... collected 1 item

tests/test_pipelines.py::test_pipeline_execution [
  {
    "status": "start",
    "total_steps": 2
  },
  {
    "status": "progress",
    "step_index": 0,
    "step_name": "sanitize",
    "message": "Running sanitize..."
  },
  {
    "status": "error",
    "message": "Input file pipeline_test.pdf not found"
  }
]
FAILED

=================================== FAILURES ===================================
___________________________ test_pipeline_execution ____________________________

client = <FlaskClient <Flask 'app'>>, upload_folder = '/tmp/tmp3xs05em0'
output_folder = '/tmp/tmpwgg41n2k'

    def test_pipeline_execution(client, upload_folder, output_folder):
        # 1. Create a PDF
        input_path = os.path.join(upload_folder, 'pipeline_test.pdf')
        pdf = pikepdf.new()
        pdf.add_blank_page()
        # Add simple JS to sanitize
        pdf.Root.Names = pikepdf.Dictionary({
            '/JavaScript': pikepdf.Dictionary({
                 '/Names': [pikepdf.Name('/Test'), pikepdf.Dictionary(S=pikepdf.Name('/JavaScript'), JS=b"console.log('test')")]
            })
        })
        pdf.save(input_path)
    
        # 2. Call Pipeline
        data = {
            'filename': 'pipeline_test.pdf',
            'steps': [
                {'op': 'sanitize'},
                {'op': 'compress'}
            ]
        }
    
        response = client.post('/api/pipeline/run', json=data)
    
        assert response.status_code == 200
        assert response.mimetype == 'text/event-stream'
    
        # 3. Read Stream
        # Flask test client .data gives full content.
        content = response.data.decode('utf-8')
        lines = content.split('\n')
    
        updates = []
        for line in lines:
            if line.startswith('data: '):
                update = json.loads(line[6:])
                updates.append(update)
    
        print(json.dumps(updates, indent=2))
    
        # Start
        assert updates[0]['status'] == 'start'
        assert updates[0]['total_steps'] == 2
    
        # Step 1: Sanitize
        assert updates[1]['status'] == 'progress'
        assert updates[1]['step_name'] == 'sanitize'
    
        # Step 2: Compress
>       assert updates[2]['status'] == 'progress'
E       AssertionError: assert 'error' == 'progress'
E         - progress
E         + error

tests/test_pipelines.py:57: AssertionError
------------------------------ Captured log call -------------------------------
ERROR    pipeline_executor:pipeline_executor.py:43 Pipeline failed at step sanitize: Input file pipeline_test.pdf not found
=============================== warnings summary ===============================
<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyPacked has no __module__ attribute

<frozen importlib._bootstrap>:488
  <frozen importlib._bootstrap>:488: DeprecationWarning: builtin type SwigPyObject has no __module__ attribute

../../../anaconda3/lib/python3.12/site-packages/pypdf/_crypt_providers/_cryptography.py:32
  /home/matis/anaconda3/lib/python3.12/site-packages/pypdf/_crypt_providers/_cryptography.py:32: CryptographyDeprecationWarning: ARC4 has been moved to cryptography.hazmat.decrepit.ciphers.algorithms.ARC4 and will be removed from this module in 48.0.0.
    from cryptography.hazmat.primitives.ciphers.algorithms import AES, ARC4

-- Docs: https://docs.pytest.org/en/stable/how-to/capture-warnings.html
=========================== short test summary info ============================
FAILED tests/test_pipelines.py::test_pipeline_execution - AssertionError: ass...
======================== 1 failed, 3 warnings in 0.23s =========================
