<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Content Extractor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .upload-zone {
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            background-color: #fff;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-zone:hover,
        .upload-zone.dragover {
            border-color: #0d6efd;
            background-color: #f1f8ff;
        }

        .file-list-card {
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
            border: none;
        }

        .sticky-sidebar {
            position: -webkit-sticky;
            position: sticky;
            top: 20px;
        }

        .batch-btn-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center gap-2" href="/">
                <i class="bi bi-file-earmark-pdf-fill"></i>
                PDF Extractor & Editor
            </a>
            <button class="btn btn-outline-light btn-sm ms-auto" data-bs-toggle="modal"
                data-bs-target="#bugReportModal">
                <i class="bi bi-bug me-1"></i> Report Issue
            </button>
        </div>
    </nav>

    <div class="container mb-5">

        <!-- Upload Section -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="card upload-zone p-5 text-center" onclick="document.getElementById('pdf_file').click()">
                    <form action="/upload" method="post" enctype="multipart/form-data" id="upload-form">
                        <i class="bi bi-cloud-arrow-up text-primary mb-3" style="font-size: 3rem;"></i>
                        <h4 class="fw-normal">Drag and drop PDF files here</h4>
                        <p class="text-muted">or click to browse from your computer</p>
                        <input type="file" class="d-none" id="pdf_file" name="pdf_file" accept=".pdf" multiple
                            onchange="document.getElementById('upload-form').submit()" data-testid="file-upload-input">
                    </form>
                </div>
            </div>
        </div>

        <div class="row g-4">
            <!-- Library Section -->
            <div class="col-lg-8">
                <div class="card file-list-card h-100">
                    <div
                        class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0 fw-bold"><i class="bi bi-collection me-2"></i>Library</h5>
                        <span class="badge bg-light text-dark border">{{ uploaded_files|length }} Files</span>
                    </div>
                    <div class="card-body px-0">
                        {% if uploaded_files %}
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="bg-light">
                                    <tr>
                                        <th style="width: 40px;" class="ps-4">
                                            <input class="form-check-input" type="checkbox" id="check-all">
                                        </th>
                                        <th>Filename</th>
                                        <th class="text-end pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for file in uploaded_files %}
                                    <tr>
                                        <td class="ps-4">
                                            <input class="form-check-input file-checkbox" type="checkbox"
                                                value="{{ file }}">
                                        </td>
                                        <td>
                                            <i class="bi bi-file-earmark-pdf text-danger me-2"></i>
                                            <span class="fw-medium">{{ file }}</span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <a href="{{ url_for('editor', filename=file) }}"
                                                class="btn btn-sm btn-outline-primary rounded-pill px-3">
                                                Edit <i class="bi bi-arrow-right ms-1"></i>
                                            </a>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        {% else %}
                        <div class="text-center py-5">
                            <i class="bi bi-folder2-open text-muted" style="font-size: 2rem;"></i>
                            <p class="text-muted mt-2">Library is empty. Upload files to get started.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Batch Operations Sidebar -->
            <div class="col-lg-4">
                <div class="sticky-sidebar">
                    <div class="card file-list-card mb-4">
                        <div class="card-header bg-success text-white py-3">
                            <h5 class="card-title mb-0"><i class="bi bi-lightning-charge me-2"></i>Batch Actions</h5>
                        </div>
                        <div class="card-body">
                            <p class="text-muted small mb-3">Select files from the library to perform actions.</p>

                            <div id="batch-actions-container" class="d-none">
                                <div class="mb-3">
                                    <label class="form-label small fw-bold text-uppercase text-muted">Extraction
                                        Settings</label>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <select id="batch-extraction-type" class="form-select form-select-sm">
                                                <option value="word">Word (.docx)</option>
                                                <option value="odt">ODT</option>
                                                <option value="csv">CSV (Tables)</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <select id="batch-target-lang" class="form-select form-select-sm">
                                                <!-- Populated dynamically -->
                                            </select>
                                        </div>
                                        <!-- Hidden/Implicit source lang for simplicity or full optionality -->
                                        <div class="col-12">
                                            <select id="batch-source-lang" class="form-select form-select-sm mt-2"
                                                style="display:none">
                                                <!-- Keeping logic but hiding for cleaner UI unless requested, or just include -->
                                                <option value="en">English (Source)</option>
                                                <!-- ... -->
                                            </select>
                                            <!-- Let's keep the existing source dropdown logic but maybe simplified -->
                                        </div>
                                    </div>
                                </div>

                                <div class="d-grid gap-2 mb-3">
                                    <button class="btn btn-success" onclick="processBatch()">
                                        <i class="bi bi-play-fill me-1"></i> Extract & Translate
                                    </button>
                                </div>

                                <label class="form-label small fw-bold text-uppercase text-muted">Tools</label>
                                <div class="batch-btn-grid">
                                    <button class="btn btn-outline-secondary btn-sm" onclick="mergeSelectedFiles()">
                                        <i class="bi bi-files me-1"></i> Merge
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="compressSelectedFiles()">
                                        <i class="bi bi-arrows-collapse me-1 text-warning"></i> Compress
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="convertToJpg()">
                                        <i class="bi bi-file-image me-1 text-info"></i> To JPG
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="repairSelectedFiles()">
                                        <i class="bi bi-tools me-1 text-danger"></i> Repair
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="compareSelectedFiles()">
                                        <i class="bi bi-file-diff me-1 text-primary"></i> Compare
                                    </button>
                                </div>
                            </div>

                            <div id="batch-progress-container" class="mt-3" style="display:none;"></div>
                            <button id="batch-download-btn" class="btn btn-primary w-100 mt-3" style="display:none;">
                                <i class="bi bi-file-zip me-1"></i> Download ZIP
                            </button>
                        </div>
                    </div>

                    <!-- Recent Downloads -->
                    {% if processed_files %}
                    <div class="card file-list-card">
                        <div class="card-header bg-white pt-3 border-bottom-0">
                            <h6 class="card-title mb-0 fw-bold">Recent Downloads</h6>
                        </div>
                        <div class="card-body">
                            <ul class="list-group list-group-flush small">
                                {% for file in processed_files[:5] %} <!-- Limit to 5 -->
                                <li class="list-group-item px-0 border-0 d-flex text-truncate">
                                    <i class="bi bi-check-circle-fill text-success me-2"></i>
                                    <a href="{{ url_for('download_file', filename=file) }}"
                                        class="text-decoration-none text-truncate" title="{{ file }}">
                                        {{ file }}
                                    </a>
                                </li>
                                {% endfor %}
                            </ul>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/batch.js') }}"></script>
    <script type="module">
        import { renderLanguageDropdown, ensureLanguageInstalled } from "{{ url_for('static', filename='js/modules/language_manager.js') }}";

        document.addEventListener('DOMContentLoaded', () => {
            const batchTarget = document.getElementById('batch-target-lang');
            // We can also utilize batch-source-lang if we unhide it

            if (batchTarget) {
                // Initial render
                renderLanguageDropdown('batch-target-lang', 'none', false, null, true);
                // Actually my render function lists languages. I should manually add "No Translation" option if needed, 
                // or update renderLanguageDropdown to support an extra "None" option.
                // For now, let's just append "No Translation" manually or let render handle it if I modify it.
                // I'll modify renderLanguageDropdown to accept an 'includeNone' param or just add it manually here.

                // Let's just prepend "No Translation" after render?
                // renderLanguageDropdown is async.

                renderLanguageDropdown('batch-target-lang').then(() => {
                    const bucket = document.getElementById('batch-target-lang');
                    const noneOpt = document.createElement('option');
                    noneOpt.value = 'none';
                    noneOpt.text = 'No Translation';
                    noneOpt.selected = true;
                    bucket.insertBefore(noneOpt, bucket.firstChild);
                });

                // Add change listener to check for download
                batchTarget.addEventListener('change', async (e) => {
                    const opt = e.target.selectedOptions[0];
                    const toCode = opt.value;

                    if (toCode !== 'none' && toCode !== 'multilingual') {
                        // Source assumed 'en' for batch for now unless we enable source selector
                        const fromCode = 'en';
                        if (opt.parentElement.label.includes('Available') || !opt.getAttribute('data-installed')) {
                            // Check install
                            await ensureLanguageInstalled(fromCode, toCode);
                        }
                    }
                });
            }
        });
    </script>
    <script type="module" src="{{ url_for('static', filename='js/modules/language_manager.js') }}"></script>
    <script src="{{ url_for('static', filename='js/modules/bug_reporter.js') }}"></script>

    {% include 'partials/language_settings_modal.html' %}

    <!-- Bug Report Modal -->
    <div class="modal fade" id="bugReportModal" tabindex="-1">

        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-bug text-warning me-2"></i>Report an Issue</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">Found a bug? Describe it below and we'll generate a diagnostic
                        package for you.</p>

                    <div class="mb-3">
                        <label class="form-label fw-bold">What happened?</label>
                        <textarea id="bug-description" class="form-control" rows="4"
                            placeholder="Example: The PDF extraction failed when I tried to convert 'invoice.pdf' to Word..."></textarea>
                    </div>

                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body py-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-logs-check" checked>
                                <label class="form-check-label small" for="include-logs-check">
                                    Include debug logs (Recommended)
                                </label>
                            </div>
                            <div id="system-info-preview" class="mt-2 ps-4">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" id="bug-report-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="generate-report-btn">
                        <i class="bi bi-magic me-1"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>

</html>