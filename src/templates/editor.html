<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Editor - {{ filename }}</title>
    <link rel="icon" href="data:,">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/editor.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ai_chat.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/image_editor.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/text_editor.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/note_annotations.css') }}">
</head>

<body>
    <!-- Overlay -->
    <div id="processing-overlay">
        <h3 class="mb-4">Processing Document...</h3>
        <div class="progress mb-3">
            <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar"
                style="width: 0%">0%</div>
        </div>
        <p id="status-text" class="lead">Starting...</p>
    </div>

    <!-- Title Bar -->


    <!-- Main Horizontal Layout -->
    <!-- Sidebar (Left Column) -->
    <div id="sidebar" data-testid="sidebar">
        <h5 class="mb-3">Pages</h5>
        <div id="thumbnails-container" class="mb-3"></div>

        <!-- Extraction Result Modal -->
        <!-- Extraction Result Modal -->

        <!-- Modals moved to bottom of body to prevent z-index issues -->


        <!-- Hidden inputs for Ribbon actions -->
        <input type="file" id="image-upload" accept="image/*" style="display:none;"
            onchange="window.handleImageUpload(this)">
        <input type="file" id="pdf-append" accept=".pdf" style="display:none;">

        <div id="document-info-panel" class="mt-auto mb-0 p-2 border-top">
            <!-- Properties injected by JS -->
        </div>
    </div>


    <!-- Right Column: Tabs, Ribbon, Preview -->
    <div id="main-content-wrapper">
        <div id="tab-bar" class="header-bar">
            <!-- Left Side: Branding & File -->
            <div class="d-flex align-items-center gap-2 me-3">
                <a href="/" class="text-decoration-none text-body" title="Back to Library">
                    <i class="bi bi-arrow-left-circle-fill" style="font-size: 1.2rem;"></i>
                </a>
                <span class="fw-bold fs-6">PDF Editor</span>
                <span class="badge bg-secondary ms-2 small" title="Application Version">v1.0.0</span>

                <div class="vr mx-2 h-50"></div>

                <span class="file-name small text-muted border-0 p-0">{{ filename }}</span>

                <div class="vr mx-2 h-50"></div>
            </div>
            <!-- Tabs injected here by JS -->

            <!-- Right Side: Utils -->
            <div class="ms-auto d-flex gap-3 align-items-center">
                <button id="theme-toggle" class="btn btn-link text-body p-0" onclick="toggleDarkMode()"
                    title="Toggle Dark Mode">
                    <i class="bi bi-moon"></i>
                </button>
                <button class="btn btn-link text-warning p-0" data-bs-toggle="modal" data-bs-target="#bugReportModal"
                    title="Report Issue">
                    <i class="bi bi-bug-fill"></i>
                </button>
                <button class="btn btn-link text-body p-0 ms-2" data-bs-toggle="modal" data-bs-target="#settingsModal"
                    title="Settings" aria-label="Settings">
                    <i class="bi bi-gear fs-6"></i>
                </button>
            </div>
        </div>

        <div id="ribbon-container">
            <div id="ribbon-content"></div>
        </div>

        <div id="main-preview-container">
            <div id="main-preview">
                <div id="pdf-viewer"></div>
            </div>
        </div>
    </div>


    <!-- Extraction Result Modal -->
    <!-- Extraction Result Modal -->




    <!-- Password Prompt Modal -->
    <div id="password-prompt-modal" class="modal fade" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Password Required</h5>
                </div>
                <div class="modal-body">
                    <p>This PDF is protected. Please enter the password to open it.</p>
                    <div class="mb-3">
                        <input type="password" id="pdf-open-password" class="form-control" placeholder="Password"
                            onkeydown="if(event.key==='Enter') submitPassword()">
                    </div>
                    <div id="password-error" class="text-danger mt-2 small" style="display:none;"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="cancelPassword()">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitPassword()">Open</button>
                </div>
            </div>
        </div>
    </div>

    {% include 'partials/language_settings_modal.html' %}


    <!-- Security Options Modal -->
    <div id="security-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-shield-lock me-2"></i>PDF Security</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Set New Password</label>
                        <input type="password" id="new-pdf-password" class="form-control mb-2"
                            placeholder="New Password">
                        <input type="password" id="confirm-pdf-password" class="form-control"
                            placeholder="Confirm Password">
                        <div class="form-text">Leave blank to remove password protection.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSecuritySettings()">Save
                        Settings</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div class="item" id="delete-item">Delete</div>
    </div>



    <!-- Modals preserved below -->

    <!-- ... existing ... -->



    <!-- ... existing ... -->

    <!-- Signature Modal -->
    <div class="modal fade" id="signatureModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Signature</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ul class="nav nav-tabs mb-3" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" id="tab-draw" data-bs-toggle="tab"
                                data-bs-target="#sig-draw" type="button" role="tab">Draw</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-type" data-bs-toggle="tab" data-bs-target="#sig-type"
                                type="button" role="tab">Type</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="tab-upload" data-bs-toggle="tab" data-bs-target="#sig-upload"
                                type="button" role="tab">Upload</button>
                        </li>
                    </ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="sig-draw" role="tabpanel">
                            <div class="border bg-light mb-2" style="height: 200px; cursor: crosshair;">
                                <canvas id="signature-canvas"
                                    style="width: 100%; height: 100%; touch-action: none;"></canvas>
                            </div>
                            <button class="btn btn-sm btn-outline-secondary" onclick="clearSignature()">Clear</button>
                        </div>
                        <div class="tab-pane fade" id="sig-type" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Type Name</label>
                                <input type="text" class="form-control form-control-lg" id="sig-type-input"
                                    placeholder="John Doe" style="font-family: 'Dancing Script', cursive;">
                            </div>
                        </div>
                        <div class="tab-pane fade" id="sig-upload" role="tabpanel">
                            <div class="mb-3">
                                <label class="form-label">Upload Image</label>
                                <input type="file" class="form-control" id="sig-upload-input"
                                    accept="image/png, image/jpeg">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applySignature()">Apply
                        Signature</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ... existing content ... -->

    <!-- Page Numbers Modal -->
    <div class="modal fade" id="pageNumbersModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Page Numbers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Format</label>
                        <select class="form-select" id="pn-format">
                            <option value="Page X of Y">Page X of Y</option>
                            <option value="Page X">Page X</option>
                            <option value="X of Y">X of Y</option>
                            <option value="X">X</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Position</label>
                        <select class="form-select" id="pn-position">
                            <option value="bottom-center">Bottom Center</option>
                            <option value="bottom-right">Bottom Right</option>
                            <option value="bottom-left">Bottom Left</option>
                            <option value="top-center">Top Center</option>
                            <option value="top-right">Top Right</option>
                            <option value="top-left">Top Left</option>
                        </select>
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Start Number</label>
                            <input type="number" class="form-control" id="pn-start" value="1" min="1">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Font Size</label>
                            <input type="number" class="form-control" id="pn-size" value="12" min="8" max="72">
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyPageNumbers()">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Watermark Modal -->
    <div class="modal fade" id="watermarkModal" tabindex="-1" data-testid="watermark-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add Watermark</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Watermark Text</label>
                        <input type="text" class="form-control" id="watermark-text" value="CONFIDENTIAL">
                    </div>
                    <div class="row g-2">
                        <div class="col-6">
                            <label class="form-label">Color</label>
                            <input type="color" class="form-control form-control-color w-100" id="watermark-color"
                                value="#cccccc">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Opacity (0-1)</label>
                            <input type="number" class="form-control" id="watermark-opacity" value="0.3" step="0.1"
                                min="0.1" max="1.0">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Size</label>
                            <input type="number" class="form-control" id="watermark-size" value="48" min="12" max="120">
                        </div>
                        <div class="col-6">
                            <label class="form-label">Rotation</label>
                            <select class="form-select" id="watermark-rotation">
                                <option value="45">Diagonal (45°)</option>
                                <option value="0">Horizontal (0°)</option>
                                <option value="-45">Diagonal (-45°)</option>
                                <option value="90">Vertical (90°)</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="applyWatermark()"
                        data-testid="apply-watermark-btn">Apply</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Translate Document Modal -->
    <div class="modal fade" id="translateDocumentModal" tabindex="-1" aria-labelledby="translateModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="translateModalLabel"><i class="bi bi-translate me-2"></i>Translate
                        Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Translate the entire document. The output will be a Word (.docx) file.
                    </p>

                    <div class="mb-3">
                        <label for="translate-source-lang" class="form-label">Source Language</label>
                        <select id="translate-source-lang" class="form-select"></select>
                    </div>

                    <div class="mb-3">
                        <label for="translate-target-lang" class="form-label">Target Language</label>
                        <select id="translate-target-lang" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary"
                        onclick="window.submitTranslation()">Translate</button>
                </div>
            </div>
        </div>
    </div>

    <!-- OCR Modal -->
    <div class="modal fade" id="ocrModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-eye me-2"></i>Make Searchable (OCR)</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">
                        Running OCR will detect text in scanned images and make it selectable/searchable.
                        This creates a new version of the PDF.
                    </p>
                    <div class="mb-3">
                        <label for="ocr-language" class="form-label">Document Language</label>
                        <select id="ocr-language" class="form-select"></select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="window.runOCR()">Run OCR</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Modal -->
    <div class="modal fade" id="summaryModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-earmark-text me-2"></i>Document Summary</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="summary-content" class="p-3 bg-light rounded" style="max-height: 60vh; overflow-y: auto;">
                        <!-- Summary text injected here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary"
                        onclick="navigator.clipboard.writeText(document.getElementById('summary-content').innerText); window.showToast('Copied to clipboard!', 'success')">
                        <i class="bi bi-clipboard me-1"></i> Copy
                    </button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Compare PDFs Modal -->
    <div class="modal fade" id="compareModal" tabindex="-1" data-testid="compare-modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-file-diff me-2"></i>Compare PDFs</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                        onclick="closeCompareModal()"></button>
                </div>
                <div class="modal-body">
                    <p class="text-muted small">Compare the current PDF with another PDF to highlight visual
                        differences.</p>

                    <div class="mb-3">
                        <label class="form-label">Select PDF to Compare</label>
                        <input type="file" class="form-control" id="pdf-compare" accept=".pdf"
                            onchange="handleCompareFileSelect(event)">
                    </div>

                    <div id="compare-status" class="mb-3"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
                        onclick="closeCompareModal()">Cancel</button>
                    <button type="button" class="btn btn-primary" id="compare-run-btn" onclick="runComparison()"
                        disabled data-testid="run-comparison-btn">
                        <i class="bi bi-play-circle me-1"></i>Run Comparison
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete this page? This action can be undone.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDeletePage()">Delete</button>
                </div>
            </div>
        </div>
    </div>





    <!-- Hidden Process Form (Used by Ribbon) -->



    <!-- Command Palette Modal -->
    <div id="command-palette-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <div class="input-group">
                        <span class="input-group-text bg-transparent border-0"><i class="bi bi-search"></i></span>
                        <input type="text" id="cmd-search" class="form-control border-0 shadow-none"
                            placeholder="Type a command..." autocomplete="off">
                    </div>
                </div>
                <div class="modal-body p-0">
                    <div id="cmd-results" class="list-group list-group-flush">
                        <!-- Results go here -->
                    </div>
                </div>
                <div class="modal-footer p-1">
                    <small class="text-muted ms-auto me-2">Use <kbd>↑</kbd> <kbd>↓</kbd> to navigate, <kbd>Enter</kbd>
                        to select</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        const filename = "{{ filename }}";
    </script>
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script>
        window.filename = "{{ filename }}";
    </script>
    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>
    <script type="module" src="{{ url_for('static', filename='js/modules/language_manager.js') }}"></script>
    <script type="module">
        import { renderLanguageDropdown, ensureLanguageInstalled } from "{{ url_for('static', filename='js/modules/language_manager.js') }}";

        document.addEventListener('DOMContentLoaded', () => {
            // Populate Extraction Modal Dropdowns
            const sourceSelect = document.getElementById('source-lang');
            const targetSelect = document.getElementById('target-lang');

            if (sourceSelect && targetSelect) {
                // For source, we list all installed "from" languages? Or just all available?
                // Typically source can be any language we support.
                // Let's populate with all, but prioritize english
                renderLanguageDropdown('source-lang', 'en', true);
                renderLanguageDropdown('target-lang', 'none', false, null, true);

                // Add change listener to check for download
                targetSelect.addEventListener('change', async (e) => {
                    const opt = e.target.selectedOptions[0];
                    const fromCode = sourceSelect.value === 'multilingual' ? 'en' : sourceSelect.value;
                    const toCode = opt.value;

                    if (opt.parentElement.label.includes('Available') || !opt.getAttribute('data-installed')) {
                        // Check if truly installed or needs download
                        if (toCode !== 'multilingual') {
                            // Assuming English source for download check, or we need to respect source
                            await ensureLanguageInstalled(fromCode, toCode);
                        }
                    }
                });
            }
        });
    </script>
    <script src="{{ url_for('static', filename='js/modules/bug_reporter.js') }}"></script>

    <!-- Extraction Result Modal -->
    <div id="extraction-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Extracted Text</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3 d-flex gap-2 align-items-center">
                        <label class="form-label mb-0">Translate:</label>
                        <select id="source-lang" class="form-select form-select-sm" style="width: auto;">
                            <option value="en" selected>English</option>
                        </select>
                        <span>&rarr;</span>
                        <select id="target-lang" class="form-select form-select-sm" style="width: auto;">
                            <!-- Populated dynamically -->
                        </select>
                        <button class="btn btn-sm btn-outline-primary"
                            onclick="translateExtractedText()">Translate</button>
                    </div>
                    <textarea id="extracted-text-area" class="form-control" rows="10"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyExtractedText()">Copy to
                        Clipboard</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Page Extraction Modal -->
    <div id="page-extraction-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Extract & Process Page</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Format</label>
                        <select id="page-extract-format" class="form-select">
                            <option value="docx">Word (.docx)</option>
                            <option value="odt">OpenDocument (.odt)</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitPageExtraction()">Start
                        Extraction</button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF/A Conversion Modal -->
    <div id="pdfa-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Convert to PDF/A</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Convert this document to PDF/A format (ISO 19005) for long-term archiving.</p>
                    <div class="mb-3">
                        <label class="form-label">Compliance Level</label>
                        <select id="pdfa-level" class="form-select">
                            <option value="1b">PDF/A-1b (Basic)</option>
                            <option value="2b" selected>PDF/A-2b (Recommended)</option>
                            <option value="3b">PDF/A-3b (Attachments)</option>
                        </select>
                        <div class="form-text">Level B guarantees visual preservation.</div>
                    </div>
                    <div class="alert alert-warning small">
                        Note: This process may rasterize complex transparencies and increase file size.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="convertToPdfA()">Convert &
                        Download</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Hidden Process Form (Used by Ribbon) -->
    <form action="/process_request" method="post" id="process-form" style="display:none;">
        <input type="hidden" name="filename" value="{{ filename }}">
        <input type="hidden" name="extraction_type" value="">
        <input type="hidden" name="target_lang" value="">
        <!-- Other fields if needed -->
    </form>

    <!-- Bug Report Modal -->
    <div class="modal fade" id="bugReportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-bug text-warning me-2"></i>Report an Issue</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p class="small text-muted mb-3">Found a bug? Describe it below to help us fix it.</p>

                    <div class="mb-3">
                        <label class="form-label fw-bold">What happened?</label>
                        <textarea id="bug-description" class="form-control" rows="4"
                            placeholder="Describe what you were doing when the error occurred..."></textarea>
                    </div>

                    <div class="card bg-light border-0 mb-3">
                        <div class="card-body py-2">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="include-logs-check" checked>
                                <label class="form-check-label small" for="include-logs-check">
                                    Include debug logs (Recommended)
                                </label>
                            </div>
                            <div id="system-info-preview" class="mt-2 ps-4">
                                <!-- Populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" id="bug-report-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="generate-report-btn">
                        <i class="bi bi-magic me-1"></i> Generate Report
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% include "partials/cloud_picker_modal.html" %}
    {% include "partials/settings_modal.html" %}

    <!-- Save to Cloud Provider Selection Modal -->
    <div id="save-cloud-provider-modal" class="modal fade" tabindex="-1">
        <div class="modal-dialog modal-sm">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Save to Cloud</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body d-grid gap-2">
                    <button class="btn btn-outline-danger text-start" onclick="selectCloudSaveProvider('google')">
                        <i class="bi bi-google me-2"></i> Google Drive
                    </button>
                    <button class="btn btn-outline-primary text-start" onclick="selectCloudSaveProvider('nextcloud')">
                        <i class="bi bi-cloud me-2"></i> Nextcloud
                    </button>
                    <button class="btn btn-outline-primary text-start" onclick="selectCloudSaveProvider('dropbox')">
                        <i class="bi bi-box-seam me-2"></i> Dropbox
                    </button>
                    <button class="btn btn-outline-info text-start" onclick="selectCloudSaveProvider('onedrive')">
                        <i class="bi bi-microsoft me-2"></i> OneDrive
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>

    <script type="module" src="{{ url_for('static', filename='js/main.js') }}"></script>

    <script type="module">
        import { openCloudPicker } from "{{ url_for('static', filename='js/modules/cloud_picker.js') }}";

        // Expose to window for Ribbon calls
        window.openCloudPicker = openCloudPicker;

        // Save Logic
        let saveModal = null;
        window.openSaveToCloud = function () {
            if (!saveModal) saveModal = new bootstrap.Modal(document.getElementById('save-cloud-provider-modal'));
            saveModal.show();
        };

        window.selectCloudSaveProvider = function (provider) {
            saveModal.hide();
            // Delay slightly to allow modal to close smoothly
            setTimeout(() => {
                openCloudPicker(provider, 'save');
            }, 200);
        };
    </script>
</body>

</html>