
import { state } from './state.js';

export async function summarizeDocument(mode = 'brief') {
    // Globals from utils.js
    const handleApiError = window.handleApiError || console.error;
    const showToast = window.showToast || console.log;

    // Show loading overlay
    const overlay = document.getElementById('processing-overlay');
    const statusText = document.getElementById('status-text');
    if (overlay) {
        overlay.style.display = 'flex';
        statusText.innerText = 'Analyzing document...';
    }

    try {
        // Ensure index first
        if (statusText) statusText.innerText = 'Indexing content...';
        await fetch('/ai/index', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ filename: state.filename })
        });

        // Ask for summary
        if (statusText) statusText.innerText = `Generating ${mode} summary...`;

        const response = await fetch('/ai/summarize', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                mode: mode
            })
        });

        const data = await response.json();

        if (overlay) overlay.style.display = 'none';

        if (data.summary) {
            showSummaryModal(data.summary, mode);
        } else {
            throw new Error(data.error || "No summary returned");
        }

    } catch (e) {
        if (overlay) overlay.style.display = 'none';
        handleApiError(e, "Summarization Failed");
    }
}

function showSummaryModal(summaryText, currentMode) {
    // 1. Process Page References: [Page X] -> clickable link
    // We regex replace to a span with data attribute
    const processedText = summaryText.replace(/\[Page (\d+)\]/g, (match, pageNum) => {
        return `<a href="#" class="page-ref badge bg-light text-primary text-decoration-none border" data-page="${pageNum}" onclick="event.preventDefault(); window.navigateToPage(${pageNum})"><i class="bi bi-cursor-fill me-1" style="font-size:0.7em"></i>Page ${pageNum}</a>`;
    });

    // 2. Parse Markdown
    let content = processedText;
    if (window.marked) {
        content = window.marked.parse(processedText);
    }

    // 3. Inject into Modal
    const container = document.getElementById('summary-content');

    // Add Controls if not present (we append them to top of content or checking if modal header allows it)
    // Let's inject a Toolbar
    const toolbar = `
        <div class="d-flex justify-content-between align-items-center mb-3 pb-2 border-bottom">
            <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary ${currentMode === 'brief' ? 'active' : ''}" onclick="window.summarizeDocument('brief')">Executive</button>
                <button class="btn btn-outline-primary ${currentMode === 'detailed' ? 'active' : ''}" onclick="window.summarizeDocument('detailed')">Detailed</button>
            </div>
            <div class="text-muted small">
                <i class="bi bi-info-circle me-1"></i> Generated by Local AI
            </div>
        </div>
    `;

    container.innerHTML = toolbar + `<div class="summary-body">${content}</div>`;

    // 4. Show Modal
    const modalEl = document.getElementById('summaryModal');
    const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
    modal.show();
}

// Global expose for button onclicks
window.summarizeDocument = summarizeDocument;
window.navigateToPage = function (pageNum) {
    if (window.PDFViewerApplication) {
        window.PDFViewerApplication.page = parseInt(pageNum);
        // Scroll to view
        document.getElementById('summaryModal').classList.remove('show'); // Optional: optimize UX (docking vs modal)
        // Ideally we keep modal open but maybe minimize? For now, let's just close or keep.
        // If we keep it, it covers the view.
        // Let's hide modal so user can see.
        const modal = bootstrap.Modal.getInstance(document.getElementById('summaryModal'));
        modal.hide();
    } else {
        console.error("PDFViewerApplication not found");
    }
};
