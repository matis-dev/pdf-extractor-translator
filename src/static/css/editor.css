:root {
    --bg-body: #fff;
    --bg-sidebar: #f8f9fa;
    --text-color: #212529;
    --border-color: #dee2e6;
    --card-bg: #fff;
    --thumbnail-hover: #e9ecef;
    --thumbnail-active-bg: #e7f1ff;
    --thumbnail-active-border: #0d6efd;
    --modal-bg: #fefefe;
    --modal-text: #000;
}

[data-theme="dark"] {
    --bg-body: #212529;
    --bg-sidebar: #343a40;
    --text-color: #f8f9fa;
    --border-color: #495057;
    --card-bg: #2b3035;
    --thumbnail-hover: #495057;
    --thumbnail-active-bg: #375a7f;
    --thumbnail-active-border: #375a7f;
    --modal-bg: #2b3035;
    --modal-text: #f8f9fa;
    --accent-color: #0d6efd;
    --text-color-muted: #adb5bd;
    /* For title bar buttons */
}

body {
    height: 100vh;
    display: flex;
    flex-direction: row;
    /* Horizontal split: Sidebar | Main Content */
    overflow: hidden;
    background-color: var(--bg-body);
    color: var(--text-color);
    margin: 0;
}

#layout-wrapper {
    /* No longer needed if body handles it, but let's keep it consistent */
}

/* Sidebar is now a direct child of body (via our HTML realignment) */
#sidebar {
    width: 260px;
    height: 100%;
    /* Full height */
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border-color);
    padding: 10px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    flex-shrink: 0;
    z-index: 100;
    /* Ensure checks over other elements if needed */
    z-index: 100;
    /* Ensure checks over other elements if needed */
}

/* Specific overrides for buttons/text in dark mode to ensure visibility */
[data-theme="dark"] .file-name {
    color: var(--text-color) !important;
}

[data-theme="dark"] #theme-toggle {
    color: var(--text-color) !important;
}

[data-theme="dark"] .text-body {
    color: var(--text-color) !important;
}

#main-content-wrapper {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
    min-width: 0;
    /* Prevent flex overflow */
}

/* Old #editor-container is now just the preview wrapper inside main-content-wrapper */
#main-preview-container {
    flex: 1;
    display: flex;
    overflow: hidden;
    position: relative;
    background-color: #525659;
}

#main-preview {
    flex: 1;
    background: #525659;
    overflow: auto;
    display: flex;
    justify-content: center;
    padding: 20px;
    position: relative;
    width: 100%;
    /* Ensure it fills width */
}

#pdf-viewer {
    position: relative;
    /* Center in preview */
    margin: 0 auto;
}

.page-container {
    position: relative;
    margin-bottom: 20px;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    background: white;
    /* Ensure PDF pages have white bg */
}

.text-annotation {
    position: absolute;
    border: 1px solid transparent;
    background: rgba(255, 255, 255, 0.9);
    padding: 5px;
    cursor: default;
    min-width: 50px;
    min-height: 20px;
    font-size: 16px;
    font-family: sans-serif;
    color: black;
    transition: box-shadow 0.1s;
}

.text-annotation:hover {
    border: 1px dashed #007bff;
    cursor: move;
    z-index: 100;
}

.text-annotation.dragging {
    border: 2px solid #007bff;
    cursor: grabbing;
    opacity: 0.9;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

.text-annotation[contenteditable="true"],
.text-annotation.selected {
    border: 2px solid #007bff;
    background: white;
    z-index: 101;
    outline: none;
}

.text-annotation[contenteditable="true"] {
    cursor: text;
    cursor: auto;
}

.image-annotation {
    position: absolute;
    cursor: move;
    border: 1px dashed #28a745;
    z-index: 20;
}

.image-annotation:hover {
    border: 2px solid #28a745;
}

/* Form Fields */
.form-field-wrapper {
    position: absolute;
    border: 1px dashed #fd7e14;
    /* Orange for forms */
    z-index: 50;
    cursor: move;
}

.form-field-wrapper.selected {
    border: 2px solid #fd7e14;
    z-index: 100;
}

/* Shape Wrappers */
.shape-wrapper {
    position: absolute;
    /* border: 1px dashed #6c757d;  Optional helper border? */
    cursor: move;
}

.shape-wrapper:hover {
    outline: 1px dashed #0d6efd;
}

.shape-wrapper.selected {
    outline: 2px solid #0d6efd;
    z-index: 100;
}

/* Shape Handles Visibility & Styling */
.shape-wrapper .resize-handle {
    display: none;
    position: absolute;
    width: 10px;
    height: 10px;
    background: #0d6efd;
    border: 1px solid white;
    border-radius: 50%;
    z-index: 101;
    box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
}

.shape-wrapper.selected .resize-handle {
    display: block;
}

.shape-wrapper .rotate-handle {
    display: none;
    position: absolute;
    top: -28px;
    left: 50%;
    transform: translateX(-50%);
    width: 24px;
    height: 24px;
    background: white;
    border: 1px solid #0d6efd;
    border-radius: 50%;
    z-index: 101;
    align-items: center;
    justify-content: center;
    cursor: alias;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.shape-wrapper .rotate-handle i {
    font-size: 14px;
    color: #0d6efd;
}

.shape-wrapper.selected .rotate-handle {
    display: flex;
}

.shape-content {
    pointer-events: none;
    /* Let clicks pass to wrapper */
    display: block;
}

.form-field-content {
    width: 100%;
    height: 100%;
    pointer-events: none;
    /* Let clicks go to wrapper unless editing */
}

/* Loading Overlay */
.loading-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(5px);
}

/* Page Controls */
.page-controls {
    position: absolute;
    top: 10px;
    right: -50px;
    display: flex;
    flex-direction: column;
    gap: 5px;
    z-index: 100;
}

.page-control-btn {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: none;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    transition: transform 0.1s;
}

.page-control-btn:hover {
    transform: scale(1.1);
}

.btn-rotate {
    background-color: #6c757d;
}

.btn-up {
    background-color: #0d6efd;
}

.btn-down {
    background-color: #0d6efd;
}

.btn-delete {
    background-color: #dc3545;
}

.btn-extract {
    background-color: #198754;
}

/* Modals */
/* Modals - Bootstrap Overrides for Theme */
/* We rely on Bootstrap for positioning and z-index (1055) */
/* .modal { z-index: 3000; }  <-- Removed to fix layering issues */

.modal-content {
    background-color: var(--modal-bg);
    color: var(--modal-text);
    /* margin: 15% auto; <-- Let Bootstrap handle centering */
    /* padding: 20px; */
    border: 1px solid var(--border-color);
    /* width: 80%; */
    /* max-width: 600px; */
    border-radius: 8px;
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
}

.close {
    color: #aaa;
    float: right;
    font-size: 28px;
    font-weight: bold;
    cursor: pointer;
}

.close:hover,
.close:focus {
    color: black;
    text-decoration: none;
    cursor: pointer;
}

/* Context Menu */
#context-menu {
    display: none;
    position: absolute;
    z-index: 1000;
    background: white;
    border: 1px solid #ccc;
    box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
    border-radius: 4px;
    padding: 5px 0;
    min-width: 120px;
}

#context-menu .item {
    padding: 8px 12px;
    cursor: pointer;
    font-size: 14px;
    color: #333;
}

#context-menu .item:hover {
    background-color: #f0f0f0;
}

#processing-overlay {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(255, 255, 255, 0.5);
    backdrop-filter: blur(5px);
    z-index: 1000;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}

.progress {
    width: 50%;
    height: 30px;
}

/* Thumbnails */
#thumbnails-container {
    flex: 1;
    /* Take all remaining height */
    overflow-y: auto;
    min-height: 0;
    /* Important for firefox flex scrolling */
    border: 1px solid var(--border-color);
    background: var(--card-bg);
    padding: 10px;
    border-radius: 4px;
    margin-bottom: 10px;
}

#sidebar .alert {
    margin-top: auto;
    /* Push to bottom if container doesn't fill */
    margin-bottom: 0;
    padding: 8px 10px;
    font-size: 0.85rem;
}

.thumbnail-item {
    margin-bottom: 15px;
    cursor: pointer;
    border: 2px solid transparent;
    padding: 5px;
    border-radius: 4px;
    text-align: center;
    transition: all 0.2s;
}

.thumbnail-item:hover {
    background-color: var(--thumbnail-hover);
}

.thumbnail-item.active {
    border-color: var(--thumbnail-active-border);
    background-color: var(--thumbnail-active-bg);
}

.thumbnail-item canvas {
    max-width: 100%;
    border: 1px solid #ccc;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
}

.thumbnail-label {
    font-size: 12px;
    color: #6c757d;
    margin-top: 5px;
    font-weight: 500;
}

/* RIBBON & TITLE BAR REDESIGN */
#title-bar {
    display: flex;
    align-items: center;
    background-color: var(--bg-sidebar);
    /* Match sidebar/ribbon bg for seamless look */
    /* Use a branding color or just clean white/gray? Let's go clean. */
    border-bottom: 1px solid var(--border-color);
    padding: 5px 15px;
    height: 40px;
    gap: 15px;
    justify-content: space-between;
}

.app-branding {
    display: flex;
    align-items: center;
    gap: 10px;
    font-weight: bold;
    color: var(--text-color);
    text-decoration: none;
}

.app-branding:hover {
    text-decoration: none;
    color: var(--text-color);
    /* Maintain color on hover */
}

.file-name {
    color: #6c757d;
    font-weight: normal;
    font-size: 0.9em;
    padding: 2px 8px;
    border: 1px solid transparent;
    /* Prepare for potential editability */
    border-radius: 4px;
}

.app-actions {
    display: flex;
    align-items: center;
    gap: 5px;
}

/* Merge Tabs into Title Bar? Or keep separate? 
   To mimic "Office" style (Title on top, Tabs below) is safer for space, but "Chrome" style (Tabs in title) is denser.
   Let's keep Tabs below Title for clarity, but minimize height.
*/

#tab-bar {
    background-color: var(--bg-sidebar);
    border-bottom: 1px solid var(--border-color);
    padding: 0 10px;
    display: flex;
    gap: 2px;
    height: 30px;
    /* Reduced height */
}

.tab-btn {
    background: none;
    border: 1px solid transparent;
    border-bottom: none;
    padding: 4px 12px;
    /* reduced padding */
    cursor: pointer;
    color: var(--text-color);
    border-radius: 4px 4px 0 0;
    font-size: 13px;
    line-height: 20px;
}

.tab-btn.active {
    background: var(--bg-body);
    border-color: var(--border-color);
    font-weight: 600;
    position: relative;
    top: 1px;
    border-bottom-color: var(--bg-body);
    color: #0d6efd;
    /* Highlight active tab */
}

.tab-btn:hover:not(.active) {
    background-color: var(--thumbnail-hover);
}

#ribbon-container {
    background-color: var(--bg-body);
    border-bottom: 1px solid var(--border-color);
    height: 90px;
    /* Slightly reduced */
    overflow-x: auto;
    position: relative;
    z-index: 10;
}

#ribbon-content {
    display: flex;
    height: 100%;
    padding: 5px 10px;
    gap: 15px;
}

.ribbon-group {
    display: flex;
    flex-direction: column;
    /* border-right: 1px solid var(--border-color); Removed in favor of pseudo-element */
    padding-right: 15px;
    justify-content: space-between;
    position: relative;
    /* For pseudo-element positioning */
}

/* Custom separator using pseudo-element to control height */
.ribbon-group::after {
    content: '';
    position: absolute;
    right: 0;
    top: 10px;
    /* Shorten from top */
    bottom: 25px;
    /* Shorten from bottom (above label area) */
    width: 1px;
    background-color: var(--border-color);
}

.ribbon-group.separator-full::after {
    top: 0;
    bottom: 0;
}

.ribbon-group:last-child {
    padding-right: 0;
}

.ribbon-group:last-child::after {
    display: none;
}

.ribbon-tools {
    display: flex;
    gap: 5px;
    flex: 1;
    align-items: center;
}

.ribbon-group-label {
    text-align: center;
    font-size: 10px;
    color: #6c757d;
    margin-top: 2px;
    pointer-events: none;
    text-transform: uppercase;
    letter-spacing: 0.5px;
}

.ribbon-btn {
    background: none;
    border: 1px solid transparent;
    border-radius: 4px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 5px 8px;
    color: var(--text-color);
    cursor: pointer;
    min-width: 44px;
    height: 55px;
}

.ribbon-btn:hover {
    background-color: var(--thumbnail-hover);
    border-color: var(--border-color);
    color: #0d6efd;
}

.ribbon-btn:focus {
    outline: none;
    /* Removed thick blue outline */
    background-color: var(--thumbnail-hover);
}

.ribbon-btn.active {
    background-color: var(--thumbnail-active-bg);
    color: #0d6efd;
    border-color: var(--thumbnail-active-border);
}

.ribbon-btn i {
    font-size: 18px;
    margin-bottom: 3px;
}

.ribbon-btn span {
    font-size: 10px;
    white-space: nowrap;
}

/* Adjust Sidebar */
#sidebar {
    width: 260px;
    background: var(--bg-sidebar);
    border-right: 1px solid var(--border-color);
    padding: 10px;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    /* Prevent sidebar itself from scrolling, let children scroll */
}

/* API Error Handling */
.api-error {
    color: red;
    font-weight: bold;
}

/* Annotation Layer */
.annotationLayer {
    position: absolute;
    top: 0;
    left: 0;
    pointer-events: none;
    transform-origin: 0 0;
}

.annotationLayer section {
    position: absolute;
    text-align: center;
}

.annotationLayer .linkAnnotation>a,
.annotationLayer .buttonWidgetAnnotation.pushbutton>a {
    position: absolute;
    font-size: 1em;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
}

.annotationLayer .linkAnnotation>a:hover,
.annotationLayer .buttonWidgetAnnotation.pushbutton>a:hover {
    opacity: 0.2;
    background: #ff0;
    box-shadow: 0px 2px 10px #ff0;
}

.annotationLayer .textAnnotation img {
    position: absolute;
    cursor: pointer;
}

.text-annotation {
    cursor: move;
}

.text-annotation[contenteditable="true"] {
    cursor: text;
    cursor: auto;
}

.annotationLayer .textWidgetAnnotation input,
.annotationLayer .textWidgetAnnotation textarea,
.annotationLayer .choiceWidgetAnnotation select,
.annotationLayer .buttonWidgetAnnotation.checkBox input,
.annotationLayer .buttonWidgetAnnotation.radioButton input {
    background-color: rgba(0, 54, 255, 0.13);
    border: 1px solid transparent;
    box-sizing: border-box;
    font-size: 9px;
    height: 100%;
    margin: 0;
    padding: 0 3px;
    vertical-align: top;
    width: 100%;
    cursor: pointer;
    pointer-events: auto;
}

.annotationLayer .choiceWidgetAnnotation select option {
    padding: 0;
}

.annotationLayer .buttonWidgetAnnotation.radioButton input {
    border-radius: 50%;
}

.annotationLayer .textWidgetAnnotation input:focus,
.annotationLayer .textWidgetAnnotation textarea:focus,
.annotationLayer .choiceWidgetAnnotation select:focus {
    background: none;
    border: 1px solid transparent;
}

.annotationLayer .popupWrapper {
    position: absolute;
    width: 20em;
}

.annotationLayer .popup {
    position: absolute;
    z-index: 200;
    max-width: 20em;
    background-color: #FFFF99;
    box-shadow: 0px 2px 5px #888;
    border-radius: 2px;
    padding: 0.6em;
    margin-left: 5px;
    cursor: pointer;
    font-family: sans-serif;
    font-size: 0.8em;
    line-height: 1.2;
}

/* Selection & Resize Handles - GLOBAL */
.selection-overlay,
.image-selection-overlay {
    position: absolute;
    border: 1px dashed #007bff;
    background: rgba(0, 123, 255, 0.05);
    /* Very subtle fill */
    z-index: 1000;
    pointer-events: none;
    /* Container doesn't block, handles do */
    transform-origin: center center;
    box-sizing: border-box;
}

/* Move Mode: Border only, no resize handles initially */
.image-selection-overlay.move-mode {
    border: 1px solid #007bff;
    /* Solid border for move mode */
    cursor: move;
    pointer-events: auto;
    /* Allow dragging the overlay itself */
}

/* Edit Mode: Dashed border with handles */
.image-selection-overlay.edit-mode {
    border: 1px dashed #007bff;
    pointer-events: none;
    /* Drag handles, not the overlay body (unless we want move in edit too?) */
}

/* Allow moving in edit mode by clicking the body? usually yes. */
.image-selection-overlay.edit-mode {
    pointer-events: auto;
    cursor: move;
}

.selection-handle,
.resize-handle {
    width: 10px;
    height: 10px;
    background: #007bff;
    border: 1px solid white;
    border-radius: 50%;
    /* Circle handles */
    position: absolute;
    pointer-events: auto;
    z-index: 1002;
    transform: translate(-50%, -50%);
    /* Center on anchor point */
}

/* Rotation Zones - Invisible interaction areas outside corners */
.rotation-zone {
    position: absolute;
    width: 24px;
    height: 24px;
    background: transparent;
    /* Invisible */
    /* background: rgba(255, 0, 0, 0.2); Debugging */
    z-index: 1001;
    pointer-events: auto;
    transform: translate(-50%, -50%);
}

.handle-nw {
    top: 0;
    left: 0;
    cursor: nwse-resize;
}

.handle-n {
    top: 0;
    left: 50%;
    cursor: ns-resize;
}

.handle-ne {
    top: 0;
    right: 0;
    cursor: nesw-resize;
}

.handle-e {
    top: 50%;
    right: 0;
    cursor: ew-resize;
}

.handle-se {
    bottom: 0;
    right: 0;
    cursor: nwse-resize;
}

.handle-s {
    bottom: 0;
    left: 50%;
    cursor: ns-resize;
}

.handle-sw {
    bottom: 0;
    left: 0;
    cursor: nesw-resize;
}

.handle-w {
    top: 50%;
    left: 0;
    cursor: ew-resize;
}

/* Delete Handle (for shapes/images if updated) */
.delete-handle {
    width: 18px;
    height: 18px;
    background: #dc3545;
    border: 1px solid white;
    border-radius: 50%;
    position: absolute;
    top: -10px;
    right: -25px;
    /* Offset from corner */
    pointer-events: auto;
    z-index: 1003;
    display: none;
    /* Hidden by default */
    align-items: center;
    justify-content: center;
    color: white;
    font-size: 12px;
    cursor: pointer;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
}

.shape-wrapper.selected .delete-handle,
.shape-wrapper:hover .delete-handle,
.text-wrapper.selected .delete-handle,
.text-wrapper:hover .delete-handle,
.image-wrapper.selected .delete-handle,
.image-wrapper:hover .delete-handle {
    display: flex;
}

/* Rotation Cursors for Zones */
.rotate-nw {
    top: -10px;
    left: -10px;
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>') 12 12, alias;
}

.rotate-ne {
    top: -10px;
    right: -10px;
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>') 12 12, alias;
}

.rotate-se {
    bottom: -10px;
    right: -10px;
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12a9 9 0 1 1-9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/></svg>') 12 12, alias;
}

.rotate-sw {
    bottom: -10px;
    left: -10px;
    cursor: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/></svg>') 12 12, alias;
}

/* Use standard replace cursors if SVGs fail or for simplicity */
.rotate-nw,
.rotate-se {
    cursor: crosshair;
}

cursor: crosshair;
}

/* Highlight Annotations */
.highlight-annotation {
    cursor: pointer;
}

.highlight-annotation.selected {
    /* Visual indicator for selection */
    filter: drop-shadow(0 0 2px #007bff);
}

.highlight-annotation path {
    transition: stroke-opacity 0.15s ease;
    pointer-events: auto;
    /* Ensure path captures events */
}

.highlight-annotation:hover path {
    stroke-opacity: 0.8 !important;
}

.highlight-annotation.selected path {
    stroke-opacity: 0.8 !important;
    /* stroke: #007bff !important; */
}